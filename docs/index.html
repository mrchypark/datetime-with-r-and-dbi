<!DOCTYPE html>
<html>
  <head>
    <title>redshift를 항해할 때 알아야할 상식사전(+협업)</title>
    <meta charset="utf-8">
    <meta name="author" content="박찬엽" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/font-awesome-animation/font-awesome-animation-emi.css" rel="stylesheet" />
    <script src="libs/fontawesome/js/fontawesome-all.min.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-47822682-14', 'auto');
      ga('send', 'pageview');
    </script>
    <link rel="stylesheet" href="custom.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">




class: center, middle, title-slide, 

## redshift를 항해할 때 알아야할 상식사전(+협업)

### &lt;https://mrchypark.github.io/datetimeR&gt;

#### [[pdf버전]](https://github.com/mrchypark/datetimeR/blob/master/docs/datetimeR.pdf) [[문의하기]](http://pf.kakao.com/_RXANd) [[의견 및 오류 신고]](https://github.com/mrchypark/datetimeR/issues/new)
#### [스타누르기](https://github.com/mrchypark/datetimeR)는 컨텐츠 제작자를 춤추게 합니다.

### 박찬엽

### 2018년 10월 19일
---
class: 
## 목차

.pull-left[
1. 발표자 소개

2. redshift 라는 DB를 항해해보자
3. 
    
3. [DBI](https://dbi.r-dbi.org/)와 함께 *dplyr*로 데이터 다루기
    - [RPostgres](https://github.com/r-dbi/RPostgres) vs [RPostgreSQL](https://github.com/tomoakin/RPostgreSQL)
    
4. 날짜 자료형을 다루는 [lubridate](https://github.com/tidyverse/lubridate)
    - timezone 문제
]

--

.pull-right[
&lt;br&gt;
&lt;br&gt;

<span>&lt;i class="fas  fa-leaf faa-bounce animated "&gt;&lt;/i&gt;</span>  협업을 위해      

  - [writexl](https://github.com/ropensci/writexl) vs [openxlsx](https://github.com/awalker89/openxlsx)
  - [googledrive](https://googledrive.tidyverse.org/)
  - [sendgridr](https://mrchypark.github.io/sendgridr/)
]

---

class: center, middle, title-slide, 


## [발표자 소개][intro]

---
코빗은 비트코인 거래소

---
분석용 DW로 redshift를 사용하고 있음

---
R의 dplyr 로 db read가 됬던거 같은데?!

---
dplyr의 가독성을 포기할 수 없었음

---
문제 

연결할 수 있는가?

---
aws의 공식 문서는 jdbc를 안내함


---
jdbc 의 단점

1. java 설치
1. 숫자와 문자로만 자료형 제공
1. bigint 의 부정확성

---
class: center, middle, title-slide, 

## R <span>&lt;i class="fas  fa-heart faa-bounce animated " style=" color:red;"&gt;&lt;/i&gt;</span> Database

---
class: 

.pull-left[
## driver list .small[(DBI supported)]

- SQLite
- MySQL(+MariaDB)
- bigquery
- Oracle
- ...
]
.pull-right[
## +noDBI .small[supported]

- MongoDB
- Redis
- CouchDB
- Elasticsearch 
- etcd 
- ...

]

--
## + sergeant .small[(with Apache Drill)]

- HBase
- MapR-DB
- HDFS
- MapR-FS
- Amazon S3
- ...



---
DBI 

---
RPostgreSQL

1. ssl 등 보안 연결 지원 미흡

큰 단점

---
RPostgres

1. postgres 팀의 표준 라이브러리(libpq) 사용 
1. DBI 패키지 관리 팀이 함께 지원 관리
1. 연결 풀 및 메모리 자동 관리

---
연결

```
conn &lt;- dbConnect(RPostgres::Postgres(),
               host = host,
               port = port,
               user = user,
               password = password,
               dbname = dbname,
               sslmode='require')

```

---
연결 성공! 했지만

---
테이블이 없다?!
```r
dbListTables(conn)
```
```
character(0)
```

---
스키마를 통해 권한 관리

실제 스키마가 뭔지는 잘 모르겠지만

현재는 폴더 같은 역할을 수행

---
스키마 내의 테이블을 보는 방법을 찾아보니 쿼리문이 있음
전부 R로 하려고 고집 부리지 않는다.

```
dbGetQuery("SELECT * FROM information_schema.tables WHERE table_schema = 'public'")
```

---
테이블 불러오기

```r
tbl(con, "table_name")
tbl(con, "schema.table_name")
```
```
Error in result_create(conn@ptr, statement) : 
  Failed to prepare query: ERROR:  relation "table_name" does not exist
```

---
schema.table_name로 테이블을 불러오기 위해서는

```r
tbl(con, sql("select * from schema.table_name"))
```

---
dbplyr 패키지

다른 좋은 함수가 많겠지만!

in_schema 명령어 지원

```r
tbl(con, in_schema("schema", "table_name"))
```

---
이제 dplyr 을 잘 사용하면 되는건가?

---
코빗은 암호화폐 거래소
24시간 운영

---
재무팀이 결산할 때 시간이 매우 중요하다.

---
재무팀의 시간 일단위 결산 마감

---
거래 발생 시점 vs 지갑 기록 시점

---
타임존
redshift는 모두 UTC 기준
거래소가 외국인도 있어서 UTC를 기준으로 시간을 기록

---



---
class: center, middle, title-slide, 

## DBI

![](https://d33wubrfki0l68.cloudfront.net/738885c8f54f3ab6118545469c28cd6635fcd656/96e0d/homepage/interact.png)

---
class: 

## redshift에 연결해보자

```r
# install.packages("remotes")
# remotes::install_github("r-dbi/RPostgres")
library(keyring)
library(DBI)
con &lt;- dbConnect(Postgres(),
                 user = user,
                 password = key_get(pw_id),
                 host = host,
                 port = port,
                 dbname = "dbname")
```
---
class: 

## 데이터 소스로서 DBI

DBI 패키지가 연결하는 database의 연결정보를 바탕으로 dplyr 문법을 사용할 수 있습니다. 그렇게 하기 위해서는 dbplyr 패키지가 필요합니다.


```r
if (!requireNamespace("dbplyr")) install.packages("dbplyr")
library(dbplyr)
```

---
class: 
# R 데이터를 DB 테이블로 만들기 copy_to()

copy_to()는 DBI의 dbWriteTable()과 같은 기능을 수행. dplyr 패키지에 속한 copy_to()는 성능 개선을 통해 dbWriteTable() 보다 빠른 속도를 제공함


```r
library(RSQLite)
library(nycflights13)

conn &lt;- dbConnect(SQLite(),
                  ":memory:")

copy_to(conn
        , flights
        , name = 'flights'
        , overwrite = T)
dbListTables(conn)
```

```
## [1] "flights"      "sqlite_stat1" "sqlite_stat4"
```

---
class: 
## 테이블의 연결정보를 R 객체에 저장 - tbl()

dbplyr과 DBI, dplyr로 데이터베이스의 테이블을 dplyr 문법으로 다루기 위해서는 DBI 패키지에서 conn 객체와 같이 테이블의 연결정보를 담고 있는 R 객체가 필요. tbl()는 DB내 테이블 연결정보를 R 객체로 만드는 함수


```r
tb_flights &lt;- tbl(conn, "flights")
tb_flights
```

```
## # Source:   table&lt;flights&gt; [?? x 19]
## # Database: sqlite 3.22.0 [:memory:]
##     year month   day dep_time sched_dep_time dep_delay arr_time
##    &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;
##  1  2013     1     1      517            515         2      830
##  2  2013     1     1      533            529         4      850
##  3  2013     1     1      542            540         2      923
##  4  2013     1     1      544            545        -1     1004
##  5  2013     1     1      554            600        -6      812
##  6  2013     1     1      554            558        -4      740
##  7  2013     1     1      555            600        -5      913
##  8  2013     1     1      557            600        -3      709
##  9  2013     1     1      557            600        -3      838
## 10  2013     1     1      558            600        -2      753
## # ... with more rows, and 12 more variables: sched_arr_time &lt;int&gt;,
## #   arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;,
## #   origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,
## #   minute &lt;dbl&gt;, time_hour &lt;dbl&gt;
```

---
class: 
### collect()

collect()는 DB에 전달하는 명령의 최종 결과를 R 객체로 가져오는 역할을 수행합니다.

.pull-left[
```r
tb_flights %&gt;%
  group_by(carrier) %&gt;%
  summarise(count = n())
```
```
# Source:   lazy query [?? x 2]
# Database: sqlite 3.22.0 [:memory:]
   carrier count
   &lt;chr&gt;   &lt;int&gt;
 1 9E      18460
 2 AA      32729
 3 AS        714
 4 B6      54635
 5 DL      48110
 6 EV      54173
 7 F9        685
 8 FL       3260
 9 HA        342
10 MQ      26397
# ... with more rows
```
]

.pull-right[

```r
tb_flights %&gt;%
  group_by(carrier) %&gt;%
  summarise(count = n()) %&gt;%
  collect()
```

```
## # A tibble: 16 x 2
##    carrier count
##    &lt;chr&gt;   &lt;int&gt;
##  1 9E      18460
##  2 AA      32729
##  3 AS        714
##  4 B6      54635
##  5 DL      48110
##  6 EV      54173
##  7 F9        685
##  8 FL       3260
##  9 HA        342
## 10 MQ      26397
## 11 OO         32
## 12 UA      58665
## 13 US      20536
## 14 VX       5162
## 15 WN      12275
## 16 YV        601
```
]
---

class: 
### show_query()

show_query()는 dplyr로 구성된 함수의 연결이 query문으로 어떻게 변환되는지를 보여줌

```r
copy_to(conn, planes, name = 'planes', temporary = FALSE)
tbl(conn, 'planes_distance') %&gt;%
  inner_join(tbl(conn, 'planes'), by='tailnum') %&gt;%
  arrange(desc(total_distance)) %&gt;%
  select(total_distance, manufacturer, model) %&gt;%
  show_query()
```
```sql
&lt;SQL&gt;
SELECT `total_distance`, `manufacturer`, `model`
FROM (SELECT *
FROM (SELECT `TBL_LEFT`.`tailnum` AS `tailnum`, `TBL_LEFT`.`count` AS `count`, `TBL_LEFT`.`mean_distance` AS `mean_distance`, `TBL_LEFT`.`total_distance` AS `total_distance`, `TBL_RIGHT`.`year` AS `year`, `TBL_RIGHT`.`type` AS `type`, `TBL_RIGHT`.`manufacturer` AS `manufacturer`, `TBL_RIGHT`.`model` AS `model`, `TBL_RIGHT`.`engines` AS `engines`, `TBL_RIGHT`.`seats` AS `seats`, `TBL_RIGHT`.`speed` AS `speed`, `TBL_RIGHT`.`engine` AS `engine`
  FROM `planes_distance` AS `TBL_LEFT`
  INNER JOIN `planes` AS `TBL_RIGHT`
  ON (`TBL_LEFT`.`tailnum` = `TBL_RIGHT`.`tailnum`)
)
ORDER BY `total_distance` DESC)
```
---
class: 

## 역시 패키지는 배신한다 .small[(aka 오해)]

---
class: 

## 숫자 자료형이 늘어났다!?

### integer64

---
class: 

## numeric

base R의 숫자 자료형

---
class: 

## 모던 R 패키지에서는

tibble 내의 dbl, integer, integer64


---
class: center, middle, title-slide, 

## 거래소는 24시간이 .yellow[모자라]

---
class: 

## 날짜 자료형이 어려워서 사실


```r
library(nycflights13)
flights
```

```
## # A tibble: 336,776 x 19
##     year month   day dep_time sched_dep_time dep_delay arr_time
##    &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;
##  1  2013     1     1      517            515         2      830
##  2  2013     1     1      533            529         4      850
##  3  2013     1     1      542            540         2      923
##  4  2013     1     1      544            545        -1     1004
##  5  2013     1     1      554            600        -6      812
##  6  2013     1     1      554            558        -4      740
##  7  2013     1     1      555            600        -5      913
##  8  2013     1     1      557            600        -3      709
##  9  2013     1     1      557            600        -3      838
## 10  2013     1     1      558            600        -2      753
## # ... with 336,766 more rows, and 12 more variables: sched_arr_time &lt;int&gt;,
## #   arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;,
## #   origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,
## #   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;
```
---
class: 

## timezone

.pull-center[
  .set[
    ![](https://c.tadst.com/gfx/tzmap/map.1538884800.png?1174)  
  ]
]

---
class: center, middle, title-slide, 

## 한국은?

--

### Asia/Seoul(KST)

--

### UTC(협정 세계시) + 9시간

---

class: 

## Timezones in base R


```r
x &lt;- "2018-01-01 06:00:00"
as.POSIXct(x)
```

```
## [1] "2018-01-01 06:00:00 KST"
```

```r
as.POSIXct(x, tz = "Asia/Seoul")
```

```
## [1] "2018-01-01 06:00:00 KST"
```

```r
Sys.timezone()
```

```
## [1] "Asia/Seoul"
```

```r
Sys.time()
```

```
## [1] "2018-10-19 02:03:23 KST"
```

---

class: 

## 우리의 DB는 UTC

데이터 베이스에서 가져온 날짜를 as.Date

```
코드와 결과 예시
```

---
class: center, middle, title-slide, 

## 헷갈리기 딱 좋음



---
class: 

## 느낀 점

- 역시 삽질
- ...

---
class: center, middle, title-slide, 

## 협업을 위한 패키지들

---
class: 

## 엑셀로 저장하기

```r
library(openxlsx)
library(writexl)
```

```r
library(microbenchmark)
library(nycflights13)
microbenchmark(
  writexl = writexl::write_xlsx(flights, tempfile()),
  openxlsx = openxlsx::write.xlsx(flights, tempfile()),
  times = 3
)
writexl::write_xlsx(flights, tmp1 &lt;- tempfile())
file.info(tmp1)$size
openxlsx::write.xlsx(flights, tmp2 &lt;- tempfile())
file.info(tmp2)$size
```
---
class: 

## 구글 드라이브

엑셀 파일 업로드 / 데이터 소스로써 googledrive

```r
library(googledrive)
drive_upload(media = "what_you_want_to_upload_file", 
             name = "name_of_upload_file",
             path = "where_to_upload")

```

---
class: 

## 메일 보내기

rmd로 작성한 보고서 전송

구글에서 이미지를 제거해서 임시로 html을 첨부하는 형태로 우회중

```r
library(sendgridr)
mail() %&gt;% 
  from("your@mail.com") %&gt;% 
  to("where@togo.com") %&gt;% 
  subject("mail title") %&gt;% 
  content("mail body") %&gt;% 
  attachments("what_you_want_to_upload_file")
```

```r
mail() %&gt;% 
  from("your@mail.com") %&gt;% 
  to("where@togo.com") %&gt;% 
  subject("mail title") %&gt;% 
  content("mail body") %&gt;% 
  attachments("what_you_want_to_upload_file") %&gt;% 
  send()
```

[1]: https://github.com/tidyverse/tidyverse
[2]: https://mrchypark.github.io/kisa_finR
[tidytextmining]: https://www.tidytextmining.com/
[tidytext]: https://juliasilge.github.io/tidytext/
[intro]: https://mrchypark.github.io/self-introduce/#1
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script>
(function() {
  var i, text, code, codes = document.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
})();
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>

---
title: "redshift를 항해할 때 알아야할 상식사전(+협업)"
author: "박찬엽"
date: "2018년 10월 19일"
output:
  xaringan::moon_reader:
    seal: false
    css: ["default", "custom.css"]
    lib_dir: libs
    includes:
      in_header: google_analytics.html
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: '16:9'
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(cache = T, fig.height = 5)
library(tidyverse)
library(nycflights13)
```

class: center, middle, title-slide, 

## redshift를 항해할 때 알아야할 상식사전(+협업)

### <https://mrchypark.github.io/datetimeR>

#### [[pdf버전]](https://github.com/mrchypark/datetimeR/blob/master/docs/datetimeR.pdf) [[문의하기]](http://pf.kakao.com/_RXANd) [[의견 및 오류 신고]](https://github.com/mrchypark/datetimeR/issues/new)
#### [스타누르기](https://github.com/mrchypark/datetimeR)는 컨텐츠 제작자를 춤추게 합니다.

### 박찬엽

### 2018년 10월 19일
---
class: 
## 목차

.pull-left[
1. 발표자 소개

2. redshift 라는 DB를 항해해보자
3. 
    
3. [DBI](https://dbi.r-dbi.org/)와 함께 *dplyr*로 데이터 다루기
    - [RPostgres](https://github.com/r-dbi/RPostgres) vs [RPostgreSQL](https://github.com/tomoakin/RPostgreSQL)
    
4. 날짜 자료형을 다루는 [lubridate](https://github.com/tidyverse/lubridate)
    - timezone 문제
]

--

.pull-right[
<br>
<br>

`r anicon::faa("leaf", animate="bounce")`  협업을 위해      

  - [writexl](https://github.com/ropensci/writexl) vs [openxlsx](https://github.com/awalker89/openxlsx)
  - [googledrive](https://googledrive.tidyverse.org/)
  - [sendgridr](https://mrchypark.github.io/sendgridr/)
]

---

class: center, middle, title-slide, 


## [발표자 소개][intro]

---
코빗은 비트코인 거래소

---
분석용 DW로 redshift를 사용하고 있음

---
R의 dplyr 로 db read가 됬던거 같은데?!

---
dplyr의 가독성을 포기할 수 없었음

---
문제 

연결할 수 있는가?

---
aws의 공식 문서는 jdbc를 안내함


---
jdbc 의 단점

1. java 설치
1. 숫자와 문자로만 자료형 제공
1. bigint 의 부정확성

---
class: center, middle, title-slide, 

## R `r anicon::faa("heart", animate="bounce", color="red")` Database

---
class: 

.pull-left[
## driver list .small[(DBI supported)]

- SQLite
- MySQL(+MariaDB)
- bigquery
- Oracle
- ...
]
.pull-right[
## +noDBI .small[supported]

- MongoDB
- Redis
- CouchDB
- Elasticsearch 
- etcd 
- ...

]

--
## + sergeant .small[(with Apache Drill)]

- HBase
- MapR-DB
- HDFS
- MapR-FS
- Amazon S3
- ...



---
DBI 

---
RPostgreSQL

1. ssl 등 보안 연결 지원 미흡

큰 단점

---
RPostgres

1. postgres 팀의 표준 라이브러리(libpq) 사용 
1. DBI 패키지 관리 팀이 함께 지원 관리
1. 연결 풀 및 메모리 자동 관리

---
연결

```
conn <- dbConnect(RPostgres::Postgres(),
               host = host,
               port = port,
               user = user,
               password = password,
               dbname = dbname,
               sslmode='require')

```

---
연결 성공! 했지만

---
테이블이 없다?!
```r
dbListTables(conn)
```
```
character(0)
```

---
스키마를 통해 권한 관리

실제 스키마가 뭔지는 잘 모르겠지만

현재는 폴더 같은 역할을 수행

---
스키마 내의 테이블을 보는 방법을 찾아보니 쿼리문이 있음
전부 R로 하려고 고집 부리지 않는다.

```
dbGetQuery("SELECT * FROM information_schema.tables WHERE table_schema = 'public'")
```

---
테이블 불러오기

```r
tbl(con, "table_name")
tbl(con, "schema.table_name")
```
```
Error in result_create(conn@ptr, statement) : 
  Failed to prepare query: ERROR:  relation "table_name" does not exist
```

---
schema.table_name로 테이블을 불러오기 위해서는

```r
tbl(con, sql("select * from schema.table_name"))
```

---
dbplyr 패키지

다른 좋은 함수가 많겠지만!

in_schema 명령어 지원

```r
tbl(con, in_schema("schema", "table_name"))
```

---
이제 dplyr 을 잘 사용하면 되는건가?

---
코빗은 암호화폐 거래소
24시간 운영

---
재무팀이 결산할 때 시간이 매우 중요하다.

---
재무팀의 시간 일단위 결산 마감

---
거래 발생 시점 vs 지갑 기록 시점

---
타임존
redshift는 모두 UTC 기준
거래소가 외국인도 있어서 UTC를 기준으로 시간을 기록

---



---
class: center, middle, title-slide, 

## DBI

![](https://d33wubrfki0l68.cloudfront.net/738885c8f54f3ab6118545469c28cd6635fcd656/96e0d/homepage/interact.png)

---
class: 

## redshift에 연결해보자

```r
# install.packages("remotes")
# remotes::install_github("r-dbi/RPostgres")
library(keyring)
library(DBI)
con <- dbConnect(Postgres(),
                 user = user,
                 password = key_get(pw_id),
                 host = host,
                 port = port,
                 dbname = "dbname")
```
---
class: 

## 데이터 소스로서 DBI

DBI 패키지가 연결하는 database의 연결정보를 바탕으로 dplyr 문법을 사용할 수 있습니다. 그렇게 하기 위해서는 dbplyr 패키지가 필요합니다.

```{r}
if (!requireNamespace("dbplyr")) install.packages("dbplyr")
library(dbplyr)
```

---
class: 
# R 데이터를 DB 테이블로 만들기 copy_to()

copy_to()는 DBI의 dbWriteTable()과 같은 기능을 수행. dplyr 패키지에 속한 copy_to()는 성능 개선을 통해 dbWriteTable() 보다 빠른 속도를 제공함

```{r}
library(RSQLite)
library(nycflights13)

conn <- dbConnect(SQLite(),
                  ":memory:")

copy_to(conn
        , flights
        , name = 'flights'
        , overwrite = T)
dbListTables(conn)
```

---
class: 
## 테이블의 연결정보를 R 객체에 저장 - tbl()

dbplyr과 DBI, dplyr로 데이터베이스의 테이블을 dplyr 문법으로 다루기 위해서는 DBI 패키지에서 conn 객체와 같이 테이블의 연결정보를 담고 있는 R 객체가 필요. tbl()는 DB내 테이블 연결정보를 R 객체로 만드는 함수

```{r}
tb_flights <- tbl(conn, "flights")
tb_flights
```

---
class: 
### collect()

collect()는 DB에 전달하는 명령의 최종 결과를 R 객체로 가져오는 역할을 수행합니다.

.pull-left[
```r
tb_flights %>%
  group_by(carrier) %>%
  summarise(count = n())
```
```
# Source:   lazy query [?? x 2]
# Database: sqlite 3.22.0 [:memory:]
   carrier count
   <chr>   <int>
 1 9E      18460
 2 AA      32729
 3 AS        714
 4 B6      54635
 5 DL      48110
 6 EV      54173
 7 F9        685
 8 FL       3260
 9 HA        342
10 MQ      26397
# ... with more rows
```
]

.pull-right[
```{r}
tb_flights %>%
  group_by(carrier) %>%
  summarise(count = n()) %>%
  collect()
```
]
---

class: 
### show_query()

show_query()는 dplyr로 구성된 함수의 연결이 query문으로 어떻게 변환되는지를 보여줌

```r
copy_to(conn, planes, name = 'planes', temporary = FALSE)
tbl(conn, 'planes_distance') %>%
  inner_join(tbl(conn, 'planes'), by='tailnum') %>%
  arrange(desc(total_distance)) %>%
  select(total_distance, manufacturer, model) %>%
  show_query()
```
```sql
<SQL>
SELECT `total_distance`, `manufacturer`, `model`
FROM (SELECT *
FROM (SELECT `TBL_LEFT`.`tailnum` AS `tailnum`, `TBL_LEFT`.`count` AS `count`, `TBL_LEFT`.`mean_distance` AS `mean_distance`, `TBL_LEFT`.`total_distance` AS `total_distance`, `TBL_RIGHT`.`year` AS `year`, `TBL_RIGHT`.`type` AS `type`, `TBL_RIGHT`.`manufacturer` AS `manufacturer`, `TBL_RIGHT`.`model` AS `model`, `TBL_RIGHT`.`engines` AS `engines`, `TBL_RIGHT`.`seats` AS `seats`, `TBL_RIGHT`.`speed` AS `speed`, `TBL_RIGHT`.`engine` AS `engine`
  FROM `planes_distance` AS `TBL_LEFT`
  INNER JOIN `planes` AS `TBL_RIGHT`
  ON (`TBL_LEFT`.`tailnum` = `TBL_RIGHT`.`tailnum`)
)
ORDER BY `total_distance` DESC)
```
---
class: 

## 역시 패키지는 배신한다 .small[(aka 오해)]

---
class: 

## 숫자 자료형이 늘어났다!?

### integer64

---
class: 

## numeric

base R의 숫자 자료형

---
class: 

## 모던 R 패키지에서는

tibble 내의 dbl, integer, integer64


---
class: center, middle, title-slide, 

## 거래소는 24시간이 .yellow[모자라]

---
class: 

## 날짜 자료형이 어려워서 사실

```{r}
library(nycflights13)
flights
```
---
class: 

## timezone

.pull-center[
  .set[
    ![](https://c.tadst.com/gfx/tzmap/map.1538884800.png?1174)  
  ]
]

---
class: center, middle, title-slide, 

## 한국은?

--

### Asia/Seoul(KST)

--

### UTC(협정 세계시) + 9시간

---

class: 

## Timezones in base R

```{r}
x <- "2018-01-01 06:00:00"
as.POSIXct(x)
as.POSIXct(x, tz = "Asia/Seoul")
Sys.timezone()
Sys.time()
```

---

class: 

## 우리의 DB는 UTC

데이터 베이스에서 가져온 날짜를 as.Date

```
코드와 결과 예시
```

---
class: center, middle, title-slide, 

## 헷갈리기 딱 좋음



---
class: 

## 느낀 점

- 역시 삽질
- ...

---
class: center, middle, title-slide, 

## 협업을 위한 패키지들

---
class: 

## 엑셀로 저장하기

```r
library(openxlsx)
library(writexl)
```

```r
library(microbenchmark)
library(nycflights13)
microbenchmark(
  writexl = writexl::write_xlsx(flights, tempfile()),
  openxlsx = openxlsx::write.xlsx(flights, tempfile()),
  times = 3
)
writexl::write_xlsx(flights, tmp1 <- tempfile())
file.info(tmp1)$size
openxlsx::write.xlsx(flights, tmp2 <- tempfile())
file.info(tmp2)$size
```
---
class: 

## 구글 드라이브

엑셀 파일 업로드 / 데이터 소스로써 googledrive

```r
library(googledrive)
drive_upload(media = "what_you_want_to_upload_file", 
             name = "name_of_upload_file",
             path = "where_to_upload")

```

---
class: 

## 메일 보내기

rmd로 작성한 보고서 전송

구글에서 이미지를 제거해서 임시로 html을 첨부하는 형태로 우회중

```{r}
library(sendgridr)
mail() %>% 
  from("your@mail.com") %>% 
  to("where@togo.com") %>% 
  subject("mail title") %>% 
  content("mail body")
```


```r
mail() %>% 
  from("your@mail.com") %>% 
  to("where@togo.com") %>% 
  subject("mail title") %>% 
  content("mail body") %>% 
  attachments("what_you_want_to_upload_file") %>% 
  send()
```

[1]: https://github.com/tidyverse/tidyverse
[2]: https://mrchypark.github.io/kisa_finR
[tidytextmining]: https://www.tidytextmining.com/
[tidytext]: https://juliasilge.github.io/tidytext/
[intro]: https://mrchypark.github.io/self-introduce/#1